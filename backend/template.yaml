AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: |
  Family Archive - Document AI: AI-powered platform for preserving family memories, letters, and photos.

  IMPORTANT: STACK NAME MUST BE LOWERCASE (e.g., doc-ai, fam-archive, memory-app)

  This template creates a new stack. To update an existing stack, use CloudFormation Console > Stacks > [Your Stack] > Update.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterLabels:
      AppDomain:
        default: "Application Domain (for OAuth)"
      ArchiveBucket:
        default: "Archive S3 Bucket Name"
      GeminiApiKey:
        default: "Google Gemini API Key"
      GoogleClientId:
        default: "Google OAuth Client ID"
      GoogleClientSecret:
        default: "Google OAuth Client Secret"
      AdminEmail:
        default: "Administrator Email"
      SesFromEmail:
        default: "Notification From Email"
      RagStackAdminEmail:
        default: "RAGStack Admin Email"
      RagStackBuildWebComponent:
        default: "Build Chat Widget"
      RagStackBuildDashboard:
        default: "Build Admin Dashboard"
    ParameterGroups:
      - Label:
          default: "Deployment Configuration"
        Parameters:
          - AppDomain
          - ArchiveBucket
          - TableName
          - DeployUI
      - Label:
          default: "Authentication & API Keys"
        Parameters:
          - GoogleClientId
          - GoogleClientSecret
          - GeminiApiKey
      - Label:
          default: "Email Notifications"
        Parameters:
          - AdminEmail
          - SesFromEmail
      - Label:
          default: "RAGStack AI Configuration"
        Parameters:
          - RagStackAdminEmail
          - RagStackBuildWebComponent
          - RagStackBuildDashboard
          - RagStackTemplateUrl
      - Label:
          default: "Advanced Options"
        Parameters:
          - AllowedOrigins
          - UISourceBucket
          - UISourceKey

  DeploymentNotes: |
    ⚠️ CRITICAL: Stack Name Requirements
    - Must be LOWERCASE only (a-z, 0-9, hyphens)
    - Maximum 12 characters recommended
    - Examples: doc-ai, fam-archive, memory-app
    - Uppercase or long names will cause S3 bucket creation failures

    Initial Deployment:
    - This one-click URL creates a NEW stack
    - Required parameters: AdminEmail, RagStackAdminEmail
    - Optional: Set AppDomain to your domain, or use default localhost:5173
    - OAuth credentials (GoogleClientId/Secret) can be added later

    To Update an Existing Stack:
    - This one-click URL ONLY creates new stacks
    - To update parameters or template:
      1. Go to CloudFormation Console > Stacks
      2. Select your stack
      3. Click "Update"
      4. Choose "Replace current template" and paste template URL
      5. Modify parameters as needed

Parameters:
  AllowedOrigins:
    Type: String
    Description: CORS allowed origins
    Default: '*'

  AppDomain:
    Type: String
    Description: App domain for OAuth callbacks - Use 'localhost:5173' for local dev, or set to your Amplify domain after first deployment (e.g., 'main.d123abc.amplifyapp.com'). Update via CloudFormation Console.
    Default: 'localhost:5173'

  GoogleClientId:
    Type: String
    Description: Google OAuth Client ID (leave empty to skip Google OAuth setup)
    Default: ''

  GoogleClientSecret:
    Type: String
    Description: Google OAuth Client Secret
    Default: ''
    NoEcho: true

  TableName:
    Type: String
    Description: DynamoDB table name (single table design) - auto-generated from stack name if not specified
    Default: ''

  ArchiveBucket:
    Type: String
    Description: S3 bucket for letters, media, and profile photos - auto-generated from stack name if not specified
    Default: ''

  RagStackTemplateUrl:
    Type: String
    Description: S3 URL of the packaged RAGStack CloudFormation template
    Default: 'https://ragstack-quicklaunch-public-631094035453.s3.us-east-1.amazonaws.com/ragstack-template.yaml'

  RagStackAdminEmail:
    Type: String
    Description: Admin email for RAGStack (only required for new deployments)
    Default: 'placeholder@example.com'

  RagStackBuildWebComponent:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Build RAGStack chat widget. On initial deployment use 'true'. When updating stack via Console, set to 'false' to skip rebuild.

  RagStackBuildDashboard:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Build RAGStack admin dashboard. On initial deployment use 'true'. When updating stack via Console, set to 'false' to skip rebuild.

  SesFromEmail:
    Type: String
    Description: Email address to send notifications from (domain must be verified in SES)
    Default: ''

  AdminEmail:
    Type: String
    Description: Admin email address for contact form submissions
    Default: ''

  GeminiApiKey:
    Type: String
    Description: Google Gemini API Key
    Default: ''
    NoEcho: true

  # UI Source for one-click deployments (auto-configured for marketplace)
  UISourceBucket:
    Type: String
    Description: S3 bucket containing frontend source zip
    Default: 'hold-that-thought-quicklaunch-public'

  UISourceKey:
    Type: String
    Description: S3 key for frontend source zip
    Default: 'frontend.zip'

  DeployUI:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Deploy frontend via Amplify (includes full-stack deployment)

Conditions:
  HasGoogleOAuth: !Not [!Equals [!Ref GoogleClientId, '']]
  IsLocalhost: !Equals [!Select [0, !Split [":", !Ref AppDomain]], "localhost"]
  HasTableName: !Not [!Equals [!Ref TableName, '']]
  HasArchiveBucket: !Not [!Equals [!Ref ArchiveBucket, '']]
  ShouldDeployUI: !And
    - !Equals [!Ref DeployUI, 'true']
    - !Not [!Equals [!Ref UISourceBucket, '']]

Globals:
  Function:
    Runtime: nodejs24.x
    Timeout: 30
    MemorySize: 512
    Architectures:
      - x86_64
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'"
    GatewayResponses:
      DEFAULT_4XX:
        ResponseParameters:
          Headers:
            Access-Control-Allow-Origin: "'*'"
            Access-Control-Allow-Headers: "'Content-Type,Authorization'"
      DEFAULT_5XX:
        ResponseParameters:
          Headers:
            Access-Control-Allow-Origin: "'*'"
            Access-Control-Allow-Headers: "'Content-Type,Authorization'"
    Auth:
      DefaultAuthorizer: CognitoAuthorizer
      AddDefaultAuthorizerToCorsPreflight: false
      Authorizers:
        CognitoAuthorizer:
          UserPoolArn: !GetAtt UserPool.Arn

Resources:
  # =============================================================================
  # Cognito User Pool
  # =============================================================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${AWS::StackName}-users'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: true
        - Name: name
          Required: false
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
          RequireUppercase: true
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${AWS::StackName}-client'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      SupportedIdentityProviders:
        - COGNITO
      CallbackURLs:
        - !If [IsLocalhost, !Sub 'http://${AppDomain}/auth/callback', !Ref 'AWS::NoValue']
        - !Sub 'https://${AppDomain}/auth/callback'
      LogoutURLs:
        - !If [IsLocalhost, !Sub 'http://${AppDomain}/auth/logout', !Ref 'AWS::NoValue']
        - !Sub 'https://${AppDomain}/auth/logout'
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      AccessTokenValidity: 4
      IdTokenValidity: 4
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days

  UserPoolClientWithGoogle:
    Type: AWS::Cognito::UserPoolClient
    Condition: HasGoogleOAuth
    DependsOn: GoogleIdentityProvider
    Properties:
      ClientName: !Sub '${AWS::StackName}-client-google'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      SupportedIdentityProviders:
        - COGNITO
        - Google
      CallbackURLs:
        - !If [IsLocalhost, !Sub 'http://${AppDomain}/auth/callback', !Ref 'AWS::NoValue']
        - !Sub 'https://${AppDomain}/auth/callback'
      LogoutURLs:
        - !If [IsLocalhost, !Sub 'http://${AppDomain}/auth/logout', !Ref 'AWS::NoValue']
        - !Sub 'https://${AppDomain}/auth/logout'
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      AccessTokenValidity: 4
      IdTokenValidity: 4
      RefreshTokenValidity: 30
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub '${AWS::StackName}-${AWS::AccountId}'
      UserPoolId: !Ref UserPool

  GoogleIdentityProvider:
    Type: AWS::Cognito::UserPoolIdentityProvider
    Condition: HasGoogleOAuth
    Properties:
      UserPoolId: !Ref UserPool
      ProviderName: Google
      ProviderType: Google
      ProviderDetails:
        client_id: !Ref GoogleClientId
        client_secret: !Ref GoogleClientSecret
        authorize_scopes: email openid profile
      AttributeMapping:
        email: email
        name: name

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub '${AWS::StackName}-identity'
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                'cognito-identity.amazonaws.com:aud': !Ref IdentityPool
              ForAnyValue:StringLike:
                'cognito-identity.amazonaws.com:amr': authenticated
      Policies:
        - PolicyName: CognitoAuthorizedPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:Invoke
                Resource: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ServerlessRestApi}/*'

  # =============================================================================
  # S3 Archive Bucket
  # =============================================================================
  ArchiveBucketResource:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !If [HasArchiveBucket, !Ref ArchiveBucket, !Sub '${AWS::StackName}-archive']
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, POST, HEAD]
            AllowedOrigins: ['*']
            ExposedHeaders: [ETag]
            MaxAge: 3000
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  # =============================================================================
  # DynamoDB Single Table
  # =============================================================================
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !If [HasTableName, !Ref TableName, !Sub '${AWS::StackName}-Table']
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # =============================================================================
  # Consolidated API Lambda
  # =============================================================================
  ApiFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/index.ts
        External:
          - '@aws-sdk/*'
    Properties:
      CodeUri: lambdas/api/
      Handler: index.handler
      Description: Consolidated API - comments, messages, profiles, reactions, media
      Environment:
        Variables:
          TABLE_NAME: !If [HasTableName, !Ref TableName, !Sub '${AWS::StackName}-Table']
          ARCHIVE_BUCKET: !Ref ArchiveBucketResource
          RAGSTACK_BUCKET: !GetAtt ragstack.Outputs.DataBucketName
          RAGSTACK_REGION: us-east-1
          LETTER_PROCESSOR_FUNCTION_NAME: !Ref LetterProcessorFunction
          SES_FROM_EMAIL: !Ref SesFromEmail
          ADMIN_EMAIL: !Ref AdminEmail
          ALLOWED_ORIGINS: !Ref AllowedOrigins
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: '*'
        - LambdaInvokePolicy:
            FunctionName: !Ref LetterProcessorFunction
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - S3CrudPolicy:
            BucketName: !Ref ArchiveBucketResource
        - S3ReadPolicy:
            BucketName: !GetAtt ragstack.Outputs.DataBucketName
      Events:
        # Comments
        GetComments:
          Type: Api
          Properties:
            Path: /v1/comments/{itemId}
            Method: get
        CreateComment:
          Type: Api
          Properties:
            Path: /v1/comments/{itemId}
            Method: post
        EditComment:
          Type: Api
          Properties:
            Path: /v1/comments/{itemId}/{commentId}
            Method: put
        DeleteComment:
          Type: Api
          Properties:
            Path: /v1/comments/{itemId}/{commentId}
            Method: delete
        AdminDeleteComment:
          Type: Api
          Properties:
            Path: /v1/admin/comments/{commentId}
            Method: delete
        # Messages
        GetConversations:
          Type: Api
          Properties:
            Path: /v1/messages/conversations
            Method: get
        GetMessages:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}
            Method: get
        CreateConversation:
          Type: Api
          Properties:
            Path: /v1/messages/conversations
            Method: post
        SendMessage:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}
            Method: post
        MessageUploadUrl:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}/upload-url
            Method: post
        AttachmentUploadUrl:
          Type: Api
          Properties:
            Path: /v1/messages/attachments/upload-url
            Method: post
        MarkAsRead:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}/read
            Method: put
        DeleteConversation:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}
            Method: delete
        DeleteMessage:
          Type: Api
          Properties:
            Path: /v1/messages/{conversationId}/{messageId}
            Method: delete
        # Profile
        GetProfile:
          Type: Api
          Properties:
            Path: /v1/profile/{userId}
            Method: get
        UpdateProfile:
          Type: Api
          Properties:
            Path: /v1/profile
            Method: put
        GetUserComments:
          Type: Api
          Properties:
            Path: /v1/profile/{userId}/comments
            Method: get
        ProfilePhotoUploadUrl:
          Type: Api
          Properties:
            Path: /v1/profile/photo/upload-url
            Method: post
        ListUsers:
          Type: Api
          Properties:
            Path: /v1/users
            Method: get
        # Reactions
        GetReactions:
          Type: Api
          Properties:
            Path: /v1/reactions/{commentId}
            Method: get
        AddReaction:
          Type: Api
          Properties:
            Path: /v1/reactions/{commentId}
            Method: post
        RemoveReaction:
          Type: Api
          Properties:
            Path: /v1/reactions/{commentId}
            Method: delete
        # Media/Downloads
        DownloadPresignedUrl:
          Type: Api
          Properties:
            Path: /v1/download/presigned-url
            Method: get
        # Letters
        ListLetters:
          Type: Api
          Properties:
            Path: /v1/letters
            Method: get
        GetLetter:
          Type: Api
          Properties:
            Path: /v1/letters/{date}
            Method: get
        UpdateLetter:
          Type: Api
          Properties:
            Path: /v1/letters/{date}
            Method: put
        GetLetterVersions:
          Type: Api
          Properties:
            Path: /v1/letters/{date}/versions
            Method: get
        RevertLetterVersion:
          Type: Api
          Properties:
            Path: /v1/letters/{date}/revert
            Method: post
        GetLetterPdf:
          Type: Api
          Properties:
            Path: /v1/letters/{date}/pdf
            Method: get
        # Letter upload/draft routes
        LetterUploadRequest:
          Type: Api
          Properties:
            Path: /v1/letters/upload-request
            Method: post
        LetterProcess:
          Type: Api
          Properties:
            Path: /v1/letters/process/{uploadId}
            Method: post
        ListDrafts:
          Type: Api
          Properties:
            Path: /v1/admin/drafts
            Method: get
        GetDraft:
          Type: Api
          Properties:
            Path: /v1/admin/drafts/{draftId}
            Method: get
        DeleteDraft:
          Type: Api
          Properties:
            Path: /v1/admin/drafts/{draftId}
            Method: delete
        PublishDraft:
          Type: Api
          Properties:
            Path: /v1/admin/drafts/{draftId}/publish
            Method: post
        # Contact (public - no auth required)
        SendContactMessage:
          Type: Api
          Properties:
            Path: /v1/contact
            Method: post
            Auth:
              Authorizer: NONE

  # =============================================================================
  # Background Processors (keep separate - different triggers)
  # =============================================================================
  ActivityAggregatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/activity-aggregator/
      Handler: index.handler
      Description: Activity aggregator - update user stats from DynamoDB streams
      Environment:
        Variables:
          TABLE_NAME: !Ref TableName
          USER_PROFILES_TABLE: !Ref TableName
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref TableName
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt DynamoDBTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 10
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["INSERT"]}'

  NotificationProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/notification-processor/
      Handler: index.handler
      Description: Notification processor - send emails from DynamoDB streams
      Environment:
        Variables:
          TABLE_NAME: !Ref TableName
          SES_FROM_EMAIL: !Ref SesFromEmail
          BASE_URL: !Sub 'https://${AppDomain}'
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref TableName
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource: '*'
      Events:
        DynamoDBStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt DynamoDBTable.StreamArn
            StartingPosition: LATEST
            BatchSize: 10
            FilterCriteria:
              Filters:
                - Pattern: '{"eventName": ["INSERT"]}'

  LetterProcessorFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: true
        EntryPoints:
          - src/index.ts
        External:
          - '@aws-sdk/*'
    Properties:
      CodeUri: lambdas/letter-processor/
      Handler: index.handler
      Description: Letter processor - merges PDFs and parses with Gemini
      Runtime: nodejs24.x
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          TABLE_NAME: !If [HasTableName, !Ref TableName, !Sub '${AWS::StackName}-Table']
          ARCHIVE_BUCKET: !Ref ArchiveBucketResource
          GEMINI_API_KEY: !Ref GeminiApiKey
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - S3CrudPolicy:
            BucketName: !Ref ArchiveBucketResource

  # =============================================================================
  # RAGStack Nested Stack
  # =============================================================================
  # NOTE: The RAGStack template uses AWS::Serverless-2016-10-31 transform.
  # The TemplateURL must point to a pre-packaged template (sam package output)
  # since nested SAM templates require packaging before deployment.
  # RAGStack is always deployed as a nested stack for marketplace deployments
  ragstack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Ref RagStackTemplateUrl
      Parameters:
        AdminEmail: !Ref RagStackAdminEmail
        StackPrefix: !Sub '${AWS::StackName}-rag'
        BuildWebComponent: !Ref RagStackBuildWebComponent
        BuildDashboard: !Ref RagStackBuildDashboard

  # =============================================================================
  # Frontend Build (CodeBuild)
  # =============================================================================

  FrontendBuildProject:
    Type: AWS::CodeBuild::Project
    Condition: ShouldDeployUI
    Properties:
      Name: !Sub '${AWS::StackName}-frontend-build'
      Description: Builds SvelteKit frontend with stack-specific environment variables
      ServiceRole: !GetAtt FrontendBuildRole.Arn
      Artifacts:
        Type: S3
        Location: !Sub '${UISourceBucket}-${AWS::AccountId}'
        Name: built-frontend.zip
        Packaging: ZIP
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
          - Name: SOURCE_BUCKET
            Value: !Sub '${UISourceBucket}-${AWS::AccountId}'
          - Name: SOURCE_KEY
            Value: !Ref UISourceKey
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2
          phases:
            pre_build:
              commands:
                - echo "Downloading frontend source from S3..."
                - aws s3 cp s3://$SOURCE_BUCKET/$SOURCE_KEY /tmp/frontend.zip
                - mkdir -p /tmp/source
                - cd /tmp/source
                - unzip /tmp/frontend.zip
            build:
              commands:
                - echo "Building frontend with environment variables..."
                - cd frontend
                - npm ci
                - npm run build
                - echo "Build complete"
            post_build:
              commands:
                - echo "Packaging built frontend..."
                - cd /tmp/source
                - zip -r /tmp/built-frontend.zip frontend/build
          artifacts:
            files:
              - '**/*'
            base-directory: /tmp/source/frontend/build
      TimeoutInMinutes: 15

  FrontendBuildRole:
    Type: AWS::IAM::Role
    Condition: ShouldDeployUI
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}-${AWS::AccountId}/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}-${AWS::AccountId}'

  FrontendBuilderFunction:
    Type: AWS::Serverless::Function
    Condition: ShouldDeployUI
    Properties:
      FunctionName: !Sub '${AWS::StackName}-frontend-builder'
      CodeUri: lambdas/frontend-builder/
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 900
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - codebuild:StartBuild
                - codebuild:BatchGetBuilds
              Resource: !GetAtt FrontendBuildProject.Arn
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

  FrontendBuild:
    Type: Custom::FrontendBuild
    Condition: ShouldDeployUI
    DependsOn:
      - ragstack
      - ApiFunction
    Properties:
      ServiceToken: !GetAtt FrontendBuilderFunction.Arn
      ProjectName: !Ref FrontendBuildProject
      EnvironmentVariables:
        - Name: PUBLIC_AWS_REGION
          Value: !Ref AWS::Region
        - Name: PUBLIC_API_GATEWAY_URL
          Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod'
        - Name: PUBLIC_COGNITO_USER_POOL_ID
          Value: !Ref UserPool
        - Name: PUBLIC_COGNITO_USER_POOL_CLIENT_ID
          Value: !Ref UserPoolClient
        - Name: PUBLIC_COGNITO_HOSTED_UI_DOMAIN
          Value: !Sub '${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com'
        - Name: PUBLIC_RAGSTACK_GRAPHQL_API_URL
          Value: !GetAtt ragstack.Outputs.GraphQLApiUrl
        - Name: PUBLIC_RAGSTACK_GRAPHQL_API_KEY
          Value: !GetAtt ragstack.Outputs.GraphQLApiKey
        - Name: PUBLIC_RAGSTACK_CHAT_WIDGET_URL
          Value: !GetAtt ragstack.Outputs.WebComponentCDNUrl

  # =============================================================================
  # Amplify Hosting
  # =============================================================================

  AmplifyApp:
    Type: AWS::Amplify::App
    Properties:
      Name: !Sub '${AWS::StackName}'
      Description: Family Archive - Document AI Platform

      # Build settings (uses amplify.yml from source, but inline as backup)
      BuildSpec: |
        version: 1
        frontend:
          phases:
            preBuild:
              commands:
                - cd frontend && npm ci
            build:
              commands:
                - cd frontend && npm run build
          artifacts:
            baseDirectory: frontend/build
            files:
              - '**/*'
          cache:
            paths:
              - frontend/node_modules/**/*

      # Environment variables (users can modify these in Amplify Console)
      EnvironmentVariables:
        - Name: PUBLIC_AWS_REGION
          Value: !Ref AWS::Region
        - Name: PUBLIC_API_GATEWAY_URL
          Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/'
        - Name: PUBLIC_COGNITO_USER_POOL_ID
          Value: !Ref UserPool
        - Name: PUBLIC_COGNITO_USER_POOL_CLIENT_ID
          Value: !If [HasGoogleOAuth, !Ref UserPoolClientWithGoogle, !Ref UserPoolClient]
        - Name: PUBLIC_COGNITO_IDENTITY_POOL_ID
          Value: !Ref IdentityPool
        - Name: PUBLIC_COGNITO_HOSTED_UI_DOMAIN
          Value: !Sub '${AWS::StackName}-${AWS::AccountId}'
        - Name: PUBLIC_COGNITO_HOSTED_UI_URL
          Value: !Sub 'https://${AWS::StackName}-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com'
        - Name: PUBLIC_RAGSTACK_GRAPHQL_URL
          Value: !GetAtt ragstack.Outputs.GraphQLApiUrl
        - Name: PUBLIC_RAGSTACK_API_KEY
          Value: !GetAtt ragstack.Outputs.GraphQLApiKey
        - Name: PUBLIC_RAGSTACK_CHAT_URL
          Value: !GetAtt ragstack.Outputs.WebComponentCDNUrl

      # SPA rewrite rule
      CustomRules:
        - Source: '</^[^.]+$|\.(?!(css|gif|ico|jpg|jpeg|js|png|txt|svg|woff|woff2|ttf|map|json|webp)$)([^.]+$)/>'
          Target: /index.html
          Status: '200'

      Tags:
        - Key: Project
          Value: HoldThatThought

  AmplifyBranch:
    Type: AWS::Amplify::Branch
    Properties:
      AppId: !GetAtt AmplifyApp.AppId
      BranchName: main
      EnableAutoBuild: false
      Stage: PRODUCTION
      EnvironmentVariables:
        - Name: NODE_ENV
          Value: production
        - Name: PUBLIC_AWS_REGION
          Value: !Ref AWS::Region
        - Name: PUBLIC_API_GATEWAY_URL
          Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod'
        - Name: PUBLIC_COGNITO_USER_POOL_ID
          Value: !Ref UserPool
        - Name: PUBLIC_COGNITO_USER_POOL_CLIENT_ID
          Value: !Ref UserPoolClient
        - Name: PUBLIC_COGNITO_HOSTED_UI_DOMAIN
          Value: !Sub '${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com'
        - Name: PUBLIC_RAGSTACK_GRAPHQL_API_URL
          Value: !GetAtt ragstack.Outputs.GraphQLApiUrl
        - Name: PUBLIC_RAGSTACK_GRAPHQL_API_KEY
          Value: !GetAtt ragstack.Outputs.GraphQLApiKey
        - Name: PUBLIC_RAGSTACK_CHAT_WIDGET_URL
          Value: !GetAtt ragstack.Outputs.WebComponentCDNUrl

  # Lambda to trigger Amplify deployment
  AmplifyDeployerFunction:
    Type: AWS::Serverless::Function
    Condition: ShouldDeployUI
    Properties:
      FunctionName: !Sub '${AWS::StackName}-amplify-deployer'
      CodeUri: lambdas/amplify-deployer/
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 900
      MemorySize: 256
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - amplify:CreateDeployment
                - amplify:StartDeployment
                - amplify:GetJob
              Resource: !Sub 'arn:${AWS::Partition}:amplify:${AWS::Region}:${AWS::AccountId}:apps/${AmplifyApp.AppId}/*'
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub 'arn:${AWS::Partition}:s3:::${UISourceBucket}-${AWS::AccountId}/*'
        - Statement:
            - Effect: Allow
              Action:
                - events:PutRule
                - events:PutTargets
                - events:DescribeRule
                - events:RemoveTargets
                - events:DeleteRule
              Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/*'
        - Statement:
            - Effect: Allow
              Action:
                - lambda:AddPermission
                - lambda:RemovePermission
              Resource: !Sub 'arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}-amplify-deployer'
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: '*'

  # Custom resource that triggers deployment during stack creation
  AmplifyDeployment:
    Type: Custom::AmplifyDeployment
    Condition: ShouldDeployUI
    DependsOn:
      - AmplifyBranch
      - FrontendBuild
    Properties:
      ServiceToken: !GetAtt AmplifyDeployerFunction.Arn
      AppId: !GetAtt AmplifyApp.AppId
      BranchName: main
      SourceBucket: !Sub '${UISourceBucket}-${AWS::AccountId}'
      SourceKey: built-frontend.zip

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/'
    Export:
      Name: !Sub '${AWS::StackName}-ApiUrl'

  TableName:
    Description: DynamoDB Table Name
    Value: !Ref DynamoDBTable

  ArchiveBucketName:
    Description: S3 Archive Bucket Name (for letters, media, and profile photos)
    Value: !Ref ArchiveBucketResource
    Export:
      Name: !Sub '${AWS::StackName}-ArchiveBucket'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !If [HasGoogleOAuth, !Ref UserPoolClientWithGoogle, !Ref UserPoolClient]

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref IdentityPool

  CognitoHostedUIUrl:
    Description: Cognito Hosted UI URL
    Value: !Sub 'https://${AWS::StackName}-${AWS::AccountId}.auth.${AWS::Region}.amazoncognito.com'

  CognitoHostedUIDomain:
    Description: Cognito Hosted UI Domain
    Value: !Sub '${AWS::StackName}-${AWS::AccountId}'

  ApiFunctionArn:
    Description: API Lambda Function ARN
    Value: !GetAtt ApiFunction.Arn

  RagStackGraphQLUrl:
    Description: RAGStack GraphQL API URL
    Value: !GetAtt ragstack.Outputs.GraphQLApiUrl
    Export:
      Name: !Sub '${AWS::StackName}-RagStackGraphQLUrl'

  RagStackApiKey:
    Description: RAGStack GraphQL API Key
    Value: !GetAtt ragstack.Outputs.GraphQLApiKey
    Export:
      Name: !Sub '${AWS::StackName}-RagStackApiKey'

  RagStackChatWidgetUrl:
    Description: RAGStack Chat Widget CDN URL (Web UI Component)
    Value: !GetAtt ragstack.Outputs.WebComponentCDNUrl
    Export:
      Name: !Sub '${AWS::StackName}-RagStackWebUICDN'

  RagStackDataBucket:
    Description: RAGStack data bucket name
    Value: !GetAtt ragstack.Outputs.DataBucketName
    Export:
      Name: !Sub '${AWS::StackName}-RagStackDataBucket'

  RagStackAdminDashboardUrl:
    Description: RAGStack Admin Dashboard URL (React UI for managing knowledge base)
    Value: !GetAtt ragstack.Outputs.UIUrl
    Export:
      Name: !Sub '${AWS::StackName}-RagStackAdminDashboard'

  AmplifyAppId:
    Description: Amplify App ID
    Value: !GetAtt AmplifyApp.AppId

  AmplifyUrl:
    Description: Amplify Hosting URL (Frontend Application CDN)
    Value: !Sub 'https://main.${AmplifyApp.DefaultDomain}'
    Export:
      Name: !Sub '${AWS::StackName}-FrontendUrl'

  AmplifyConsoleUrl:
    Description: Amplify Console URL (for managing environment variables)
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/amplify/home?region=${AWS::Region}#/${AmplifyApp.AppId}'
